__all__ = ['MissionTrace', 'CommandTrace', 'TraceRecorder']

from typing import Tuple, Iterator, Dict, Any, Optional, Type
import attr
import json
import threading

from bugzoo.core.fileline import FileLineSet

from .command import Command
from .state import State
from .connection import Message


class TraceRecorder(object):
    def __init__(self) -> None:
        self.__lock = threading.Lock()
        self.__states = []
        self.__messages = []

    def record_message(self, message: Message) -> None:
        with self.__lock:
            self.__messages.append(message)

    def record_state(self, state: State) -> None:
        with self.__lock:
            self.__states.append(state)

    def flush(self) -> Tuple[Tuple[State, ...], Tuple[Message, ...]]:
        with self.__lock:
            states = tuple(self.__states)
            messages = tuple(self.__messages)
            self.__states = []
            self.__messages = []
        return (states, messages)


@attr.s  # (frozen=True)
class CommandTrace(object):
    command = attr.ib(type=Command)
    states = attr.ib(type=Tuple[State, ...])
    # messages = attr.ib(type=Tuple[Message, ...])

    # TODO messages

    @staticmethod
    def from_dict(d: Dict[str, Any],
                  system: 'Type[System]'
                  ) -> 'CommandTrace':
        command = Command.from_dict(d['command'])
        states = tuple(system.state.from_dict(s) for s in d['states'])
        return CommandTrace(command, states)

    def to_dict(self) -> Dict[str, Any]:
        return {'command': self.command.to_dict(),
                'states': [s.to_dict() for s in self.states]}


@attr.s  # (frozen=True)
class MissionTrace(object):
    commands = attr.ib(type=Tuple[CommandTrace, ...])
    coverage = attr.ib(type=Optional[FileLineSet], default=None)

    @staticmethod
    def from_file(filename: str,
                  system: 'Type[System]'
                  ) -> 'MissionTrace':
        with open(filename, 'r') as f:
            jsn = json.load(f)
        return MissionTrace.from_dict(jsn, system)

    def to_file(self, filename: str) -> None:
        with open(filename, 'w') as f:
            json.dump(self.to_dict(), f)

    @staticmethod
    def from_dict(d: Dict[str, Any],
                  system: 'Type[System]'
                  ) -> 'MissionTrace':
        commands = tuple(CommandTrace.from_dict(c, system)
                         for c in d['commands'])
        if 'coverage' in d:
            coverage = FileLineSet.from_dict(d['coverage'])
        else:
            coverage = None
        return MissionTrace(commands, coverage)

    def to_dict(self) -> Dict[str, Any]:
        mt = {'commands': [c.to_dict() for c in self]}
        if self.coverage:
            mt['coverage'] = self.coverage.to_dict()
        return mt

    def __iter__(self) -> Iterator[CommandTrace]:
        """
        Returns an iterator over the traces for the sequence of commands
        performed during this mission.
        """
        yield from self.commands

    def add_coverage(self, coverage: FileLineSet) -> None:
        self.coverage = coverage
